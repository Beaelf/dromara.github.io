<!doctype html><html><head><title>Use case of a counter · SOFAStack</title><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge,chrome=1"><meta name=viewport content="width=device-width,minimum-scale=1"><meta name=description content="SOFAStack is a Scalable Open Financial Architecture for building cloud native applications"><meta name=generator content="Hugo 0.80.0"><link rel="shortcut icon" href=https://gw.alipayobjects.com/os/q/cms/images/jqu9346l/4ba95631-2489-4885-881f-bc7f8d787d5e_w64_h61.png type=image/png><link href=https://unpkg.com/purecss@1.0.0/build/base-min.css rel=stylesheet><link href=/css/main.css rel=stylesheet><link href=/css/zoom-image.css rel=stylesheet><script src=/js/iconfont.js></script><script src=/js/highlight.pack.js></script><script>hljs.initHighlightingOnLoad();</script><script>window.SITE_LANGUAGE="en"</script><script src=/js/app.js></script><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');ga('create','UA-142131411-1','auto');ga('send','pageview');}</script></head><body><header class=ss-header><nav class=navbar role=navigation aria-label="main navigation"><div class=navbar-brand><a class=logo-link href=/en/><img class=logo src=/img/logo.png></a><div class=-show-mobile><a id=mobile-menu-icon><svg class="icon" aria-hidden="true"><use xlink:href="#icon-menu"/></svg></a><nav id=mobile-menu><div id=js-menu-search-mobile class=navbar-search-mobile><input class=input placeholder=Search><svg class="icon" aria-hidden="true"><use xlink:href="#icon-search"/></svg></div><a href=/en/projects/><span>Projects</span><svg class="icon" aria-hidden="true"><use xlink:href="#icon-ARROW"/></svg></a>
<a href=/en/guides/><span>Guides</span><svg class="icon" aria-hidden="true"><use xlink:href="#icon-ARROW"/></svg></a>
<a href=/en/blog/><span>Blog</span><svg class="icon" aria-hidden="true"><use xlink:href="#icon-ARROW"/></svg></a>
<a href=/en/activities/><span>Activity</span><svg class="icon" aria-hidden="true"><use xlink:href="#icon-ARROW"/></svg></a>
<a href=/awesome/><span>Awesome SOFA</span><svg class="icon" aria-hidden="true"><use xlink:href="#icon-ARROW"/></svg></a>
<a href=/projects/sofa-jraft/counter-example/><span>中文</span><svg class="icon" aria-hidden="true"><use xlink:href="#icon-transfer"/></svg></a></nav></div></div><div class="navbar-menu -hidden-mobile"><div class=navbar-start><a class=navbar-item href=/en/projects/>Projects</a>
<a class=navbar-item href=/en/guides/>Guides</a>
<a class=navbar-item href=/en/blog/>Blog</a>
<a class=navbar-item href=/en/activities/>Activity</a>
<a class=navbar-item href=/awesome/>Awesome SOFA</a></div><div class=navbar-end><div class=navbar-item><div id=js-menu-search class=navbar-search><input class=input placeholder=Search><svg class="icon" aria-hidden="true"><use xlink:href="#icon-search"/></svg></div></div><div class=navbar-item><a class=translation href=/projects/sofa-jraft/counter-example/>中</a></div></div></div></nav></header><div class=ss-layout-container><aside class="ss-layout-aside -left ss-card -soft-hidden"><div id=js-drawer class=ss-toc><div id=js-drawer-handle class=drawer-handle><svg class="icon icon-menu" aria-hidden="true"><use xlink:href="#icon-menu"/></svg><svg class="icon icon-close" aria-hidden="true"><use xlink:href="#icon-close"/></svg></div><div class=drawer-body><div class=header title="SOFAJRaft is a production-level high-performance Java implementation based on the RAFT consensus algorithm. It supports MULTI-RAFT-GROUP and is suitable for high-load and low-latency scenarios.">SOFAJRaft<div class="ss-toc-list-card -hidden-mobile"><svg class="icon -hidden-mobile" aria-hidden="true"><use xlink:href="#icon-menu1"/></svg><div class=ss-tooltip><div class=toc-list><h4 class=title>Main Projects</h4><ul class=list><li class=item><a href=/en/projects/sofa-boot/overview>SOFABoot</a></li><li class=item><a href=/en/projects/sofa-rpc/overview>SOFARPC</a></li><li class=item><a href=/en/projects/sofa-tracer/overview>SOFATracer</a></li><li class=item><a href=/en/projects/sofa-lookout/overview>SOFALookout</a></li><li class=item><a href=/en/projects/sofa-registry/overview>SOFARegistry</a></li></ul></div><div class=toc-list><h4 class=title>Incubating Projects</h4><ul class=list><li class=item><a href=/en/projects/sofa-mesh/overview>SOFAMesh</a></li><li class=item><a href=/en/projects/sofa-dashboard/overview>SOFADashboard</a></li></ul></div><div class=toc-list><h4 class=title>Tool Projects</h4><ul class=list><li class=item><a href=/en/projects/sofa-bolt/overview>SOFABolt</a></li><li class=item><a href=/en/projects/sofa-jraft/overview>SOFAJRaft</a></li><li class=item><a href=/en/projects/sofa-acts/overview>SOFAActs</a></li><li class=item><a href=https://www.sofastack.tech/en/projects/sofa-boot/sofa-ark-readme/>SOFAArk</a></li></ul></div><div class=toc-list><h4 class=title>Ecosystem Projects</h4><ul class=list><li class=item><a href=https://mosn.io/en>MOSN</a></li><li class=item><a href=https://occlum.io>Occlum</a></li><li class=item><a href=https://seata.io>Seata</a></li></ul></div></div></div></div><div class=body><ul class=leaf-section><li class=item><div class=link><a title="SOFAJRaft overview" href=/en/projects/sofa-jraft/overview>SOFAJRaft overview</a></div></li><li class=item><div class=link><a title="Engine architecture" href=/en/projects/sofa-jraft/engine-architecture>Engine architecture</a></div></li><li class=item><div class=link><a title="Jepsen tests" href=/en/projects/sofa-jraft/jepson-test>Jepsen tests</a></div></li><li class=item><div class=link><svg class="icon arrow" aria-hidden="true"><use xlink:href="#icon-arrow"/></svg><a title="User guide">User guide</a></div><ul class=leaf-section><li class=item><div class=link><a title="JRaft user guide" href=/en/projects/sofa-jraft/jraft-user-guide>JRaft user guide</a></div></li><li class=item><div class=link><a title="JRaft RheaKV user guide" href=/en/projects/sofa-jraft/jraft-rheakv-user-guide>JRaft RheaKV user guide</a></div></li><li class=item><div class="link -current"><a title="Counter example" href=/en/projects/sofa-jraft/counter-example>Counter example</a></div></li></ul></li><li class=item><div class=link><a title="Maven dependency description'" href=/en/projects/sofa-jraft/maven-dependency>Maven dependency description'</a></div></li><li class=item><div class=link><a title="Release notes" href=/en/projects/sofa-jraft/release-log>Release notes</a></div></li><li class=item><div class=link><a title="Benchmark data" href=/en/projects/sofa-jraft/benchmark-performance>Benchmark data</a></div></li><li class=item><div class=link><a title="User stories" href=/en/projects/sofa-jraft/user-stories>User stories</a></div></li><li class=item><div class=link><a title=Roadmap href=/en/projects/sofa-jraft/road-map>Roadmap</a></div></li><li class=item><div class=link><svg class="icon arrow" aria-hidden="true"><use xlink:href="#icon-arrow"/></svg><a title="Related articles">Related articles</a></div><ul class=leaf-section><li class=item><div class=link><a title="Introduction to Raft algorithms" href=/en/projects/sofa-jraft/raft-introduction>Introduction to Raft algorithms</a></div></li><li class=item><div class=link><a title="Distributed consensus - Raft and JRaft" href=/en/projects/sofa-jraft/consistency-raft-jraft>Distributed consensus - Raft and JRaft</a></div></li></ul></li><li class=item><div class=link><svg class="icon arrow" aria-hidden="true"><use xlink:href="#icon-arrow"/></svg><a title=Other>Other</a></div><ul class=leaf-section><li class=item><div class=link><a title="How to contribute to SOFAJRaft" href=/en/projects/sofa-jraft/how-to-contribute-code-to-sofajraft>How to contribute to SOFAJRaft</a></div></li></ul></li></ul></div></div></div></aside><main class="ss-layout-main -card"><div class=ss-meta><div class=container><h1 class=title>Use case of a counter</h1><a class="edit-button -hidden-mobile" href=https://github.com/sofastack/sofastack.tech/edit/master/content/en/projects/sofa-jraft/counter-example/index.md>Edit</a></div><div class=meta>Update time: 2021-01-19</div></div><article class=typo><pre><code>&lt;span style=&quot;color:#66d9ef&quot;&gt;private&lt;/span&gt; &lt;span style=&quot;color:#66d9ef&quot;&gt;static&lt;/span&gt; &lt;span style=&quot;color:#66d9ef&quot;&gt;final&lt;/span&gt; &lt;span style=&quot;color:#66d9ef&quot;&gt;long&lt;/span&gt; serialVersionUID &lt;span style=&quot;color:#f92672&quot;&gt;=&lt;/span&gt; &lt;span style=&quot;color:#f92672&quot;&gt;-&lt;/span&gt;5623664785560971849L&lt;span style=&quot;color:#f92672&quot;&gt;;&lt;/span&gt;

&lt;span style=&quot;color:#66d9ef&quot;&gt;private&lt;/span&gt; &lt;span style=&quot;color:#66d9ef&quot;&gt;long&lt;/span&gt;              delta&lt;span style=&quot;color:#f92672&quot;&gt;;&lt;/span&gt;

&lt;span style=&quot;color:#66d9ef&quot;&gt;public&lt;/span&gt; &lt;span style=&quot;color:#66d9ef&quot;&gt;long&lt;/span&gt; &lt;span style=&quot;color:#a6e22e&quot;&gt;getDelta&lt;/span&gt;&lt;span style=&quot;color:#f92672&quot;&gt;()&lt;/span&gt; &lt;span style=&quot;color:#f92672&quot;&gt;{&lt;/span&gt;
    &lt;span style=&quot;color:#66d9ef&quot;&gt;return&lt;/span&gt; &lt;span style=&quot;color:#66d9ef&quot;&gt;this&lt;/span&gt;&lt;span style=&quot;color:#f92672&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color:#a6e22e&quot;&gt;delta&lt;/span&gt;&lt;span style=&quot;color:#f92672&quot;&gt;;&lt;/span&gt;
&lt;span style=&quot;color:#f92672&quot;&gt;}&lt;/span&gt;

&lt;span style=&quot;color:#66d9ef&quot;&gt;public&lt;/span&gt; &lt;span style=&quot;color:#66d9ef&quot;&gt;void&lt;/span&gt; &lt;span style=&quot;color:#a6e22e&quot;&gt;setDelta&lt;/span&gt;&lt;span style=&quot;color:#f92672&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color:#66d9ef&quot;&gt;long&lt;/span&gt; delta&lt;span style=&quot;color:#f92672&quot;&gt;)&lt;/span&gt; &lt;span style=&quot;color:#f92672&quot;&gt;{&lt;/span&gt;
    &lt;span style=&quot;color:#66d9ef&quot;&gt;this&lt;/span&gt;&lt;span style=&quot;color:#f92672&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color:#a6e22e&quot;&gt;delta&lt;/span&gt; &lt;span style=&quot;color:#f92672&quot;&gt;=&lt;/span&gt; delta&lt;span style=&quot;color:#f92672&quot;&gt;;&lt;/span&gt;
&lt;span style=&quot;color:#f92672&quot;&gt;}&lt;/span&gt;
</code></pre><p>}</p><pre><code>&lt;span style=&quot;color:#66d9ef&quot;&gt;public&lt;/span&gt; &lt;span style=&quot;color:#a6e22e&quot;&gt;GetValueRequest&lt;/span&gt;&lt;span style=&quot;color:#f92672&quot;&gt;()&lt;/span&gt; &lt;span style=&quot;color:#f92672&quot;&gt;{&lt;/span&gt;
    &lt;span style=&quot;color:#66d9ef&quot;&gt;super&lt;/span&gt;&lt;span style=&quot;color:#f92672&quot;&gt;();&lt;/span&gt;
&lt;span style=&quot;color:#f92672&quot;&gt;}&lt;/span&gt;
</code></pre><p>}
ValueResponse responses include:</p><pre><code>&lt;span style=&quot;color:#66d9ef&quot;&gt;private&lt;/span&gt; &lt;span style=&quot;color:#66d9ef&quot;&gt;static&lt;/span&gt; &lt;span style=&quot;color:#66d9ef&quot;&gt;final&lt;/span&gt; &lt;span style=&quot;color:#66d9ef&quot;&gt;long&lt;/span&gt; serialVersionUID &lt;span style=&quot;color:#f92672&quot;&gt;=&lt;/span&gt; &lt;span style=&quot;color:#f92672&quot;&gt;-&lt;/span&gt;4220017686727146773L&lt;span style=&quot;color:#f92672&quot;&gt;;&lt;/span&gt;

&lt;span style=&quot;color:#66d9ef&quot;&gt;private&lt;/span&gt; &lt;span style=&quot;color:#66d9ef&quot;&gt;long&lt;/span&gt;              value&lt;span style=&quot;color:#f92672&quot;&gt;;&lt;/span&gt;
&lt;span style=&quot;color:#66d9ef&quot;&gt;private&lt;/span&gt; &lt;span style=&quot;color:#66d9ef&quot;&gt;boolean&lt;/span&gt;           success&lt;span style=&quot;color:#f92672&quot;&gt;;&lt;/span&gt;
&lt;span style=&quot;color:#75715e&quot;&gt;/**
</code></pre><p>* redirect peer id */
private String redirect;</p><pre><code>&lt;span style=&quot;color:#66d9ef&quot;&gt;private&lt;/span&gt; String            errorMsg&lt;span style=&quot;color:#f92672&quot;&gt;;&lt;/span&gt;

&lt;span style=&quot;color:#66d9ef&quot;&gt;public&lt;/span&gt; String &lt;span style=&quot;color:#a6e22e&quot;&gt;getErrorMsg&lt;/span&gt;&lt;span style=&quot;color:#f92672&quot;&gt;()&lt;/span&gt; &lt;span style=&quot;color:#f92672&quot;&gt;{&lt;/span&gt;
    &lt;span style=&quot;color:#66d9ef&quot;&gt;return&lt;/span&gt; &lt;span style=&quot;color:#66d9ef&quot;&gt;this&lt;/span&gt;&lt;span style=&quot;color:#f92672&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color:#a6e22e&quot;&gt;errorMsg&lt;/span&gt;&lt;span style=&quot;color:#f92672&quot;&gt;;&lt;/span&gt;
&lt;span style=&quot;color:#f92672&quot;&gt;}&lt;/span&gt;

&lt;span style=&quot;color:#66d9ef&quot;&gt;public&lt;/span&gt; &lt;span style=&quot;color:#66d9ef&quot;&gt;void&lt;/span&gt; &lt;span style=&quot;color:#a6e22e&quot;&gt;setErrorMsg&lt;/span&gt;&lt;span style=&quot;color:#f92672&quot;&gt;(&lt;/span&gt;String errorMsg&lt;span style=&quot;color:#f92672&quot;&gt;)&lt;/span&gt; &lt;span style=&quot;color:#f92672&quot;&gt;{&lt;/span&gt;
    &lt;span style=&quot;color:#66d9ef&quot;&gt;this&lt;/span&gt;&lt;span style=&quot;color:#f92672&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color:#a6e22e&quot;&gt;errorMsg&lt;/span&gt; &lt;span style=&quot;color:#f92672&quot;&gt;=&lt;/span&gt; errorMsg&lt;span style=&quot;color:#f92672&quot;&gt;;&lt;/span&gt;
&lt;span style=&quot;color:#f92672&quot;&gt;}&lt;/span&gt;
&lt;span style=&quot;color:#f92672&quot;&gt;......&lt;/span&gt;
</code></pre><p>}</p><pre><code>&lt;span style=&quot;color:#a6e22e&quot;&gt;@Override&lt;/span&gt;
&lt;span style=&quot;color:#66d9ef&quot;&gt;public&lt;/span&gt; &lt;span style=&quot;color:#66d9ef&quot;&gt;void&lt;/span&gt; &lt;span style=&quot;color:#a6e22e&quot;&gt;run&lt;/span&gt;&lt;span style=&quot;color:#f92672&quot;&gt;(&lt;/span&gt;Status status&lt;span style=&quot;color:#f92672&quot;&gt;)&lt;/span&gt; &lt;span style=&quot;color:#f92672&quot;&gt;{&lt;/span&gt;
    &lt;span style=&quot;color:#75715e&quot;&gt;// Return the response to the client
</code></pre><p>if (this.done != null) {
done.run(status);
}
}</p><pre><code>&lt;span style=&quot;color:#66d9ef&quot;&gt;public&lt;/span&gt; IncrementAndGetRequest &lt;span style=&quot;color:#a6e22e&quot;&gt;getRequest&lt;/span&gt;&lt;span style=&quot;color:#f92672&quot;&gt;()&lt;/span&gt; &lt;span style=&quot;color:#f92672&quot;&gt;{&lt;/span&gt;
    &lt;span style=&quot;color:#66d9ef&quot;&gt;return&lt;/span&gt; &lt;span style=&quot;color:#66d9ef&quot;&gt;this&lt;/span&gt;&lt;span style=&quot;color:#f92672&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color:#a6e22e&quot;&gt;request&lt;/span&gt;&lt;span style=&quot;color:#f92672&quot;&gt;;&lt;/span&gt;
&lt;span style=&quot;color:#f92672&quot;&gt;}&lt;/span&gt;

&lt;span style=&quot;color:#66d9ef&quot;&gt;public&lt;/span&gt; &lt;span style=&quot;color:#66d9ef&quot;&gt;void&lt;/span&gt; &lt;span style=&quot;color:#a6e22e&quot;&gt;setRequest&lt;/span&gt;&lt;span style=&quot;color:#f92672&quot;&gt;(&lt;/span&gt;IncrementAndGetRequest request&lt;span style=&quot;color:#f92672&quot;&gt;)&lt;/span&gt; &lt;span style=&quot;color:#f92672&quot;&gt;{&lt;/span&gt;
    &lt;span style=&quot;color:#66d9ef&quot;&gt;this&lt;/span&gt;&lt;span style=&quot;color:#f92672&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color:#a6e22e&quot;&gt;request&lt;/span&gt; &lt;span style=&quot;color:#f92672&quot;&gt;=&lt;/span&gt; request&lt;span style=&quot;color:#f92672&quot;&gt;;&lt;/span&gt;
&lt;span style=&quot;color:#f92672&quot;&gt;}&lt;/span&gt;

&lt;span style=&quot;color:#66d9ef&quot;&gt;public&lt;/span&gt; ValueResponse &lt;span style=&quot;color:#a6e22e&quot;&gt;getResponse&lt;/span&gt;&lt;span style=&quot;color:#f92672&quot;&gt;()&lt;/span&gt; &lt;span style=&quot;color:#f92672&quot;&gt;{&lt;/span&gt;
    &lt;span style=&quot;color:#66d9ef&quot;&gt;return&lt;/span&gt; &lt;span style=&quot;color:#66d9ef&quot;&gt;this&lt;/span&gt;&lt;span style=&quot;color:#f92672&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color:#a6e22e&quot;&gt;response&lt;/span&gt;&lt;span style=&quot;color:#f92672&quot;&gt;;&lt;/span&gt;
&lt;span style=&quot;color:#f92672&quot;&gt;}&lt;/span&gt;
</code></pre><p>}
Server</p><pre><code>        IncrementAndAddClosure closure &lt;span style=&quot;color:#f92672&quot;&gt;=&lt;/span&gt; &lt;span style=&quot;color:#66d9ef&quot;&gt;null&lt;/span&gt;&lt;span style=&quot;color:#f92672&quot;&gt;;&lt;/span&gt;
        &lt;span style=&quot;color:#75715e&quot;&gt;// If the done callback is not null, it must be called after the log entry application. If it is not null, the current load is the leader.
</code></pre><p>if (iter.done() != null) {
// If the current node is the leader, the delta value can be directly obtained from IncrementAndAddClosure to avoid deserialization. closure = (IncrementAndAddClosure) iter.done();
delta = closure.getRequest().getDelta();
} else {
// If another node applies this log entry, it needs to deserialize IncrementAndGetRequest to get the delta value. ByteBuffer data = iter.getData();
try {
IncrementAndGetRequest request = Codecs.getSerializer(Codecs.Hessian2).decode(data.array(),
IncrementAndGetRequest.class.getName());
delta = request.getDelta();
} catch (CodecException e) {
LOG.error("Fail to decode IncrementAndGetRequest", e);
}
}
long prev = this.value.get();
// Update the state machine. long updated = value.addAndGet(delta);
// Be sure to call done after the update and return the response to the client. if (closure != null) {
closure.getResponse().setValue(updated);
closure.getResponse().setSuccess(true);
closure.run(Status.OK());
}
LOG.info("Added value={} by delta={} at logIndex={}", prev, delta, iter.getIndex());
iter.next();
}
}
CounterServer</p><pre><code>&lt;span style=&quot;color:#66d9ef&quot;&gt;public&lt;/span&gt; &lt;span style=&quot;color:#a6e22e&quot;&gt;CounterServer&lt;/span&gt;&lt;span style=&quot;color:#f92672&quot;&gt;(&lt;/span&gt;String dataPath&lt;span style=&quot;color:#f92672&quot;&gt;,&lt;/span&gt; String groupId&lt;span style=&quot;color:#f92672&quot;&gt;,&lt;/span&gt; PeerId serverId&lt;span style=&quot;color:#f92672&quot;&gt;,&lt;/span&gt; NodeOptions nodeOptions&lt;span style=&quot;color:#f92672&quot;&gt;)&lt;/span&gt; &lt;span style=&quot;color:#66d9ef&quot;&gt;throws&lt;/span&gt; IOException &lt;span style=&quot;color:#f92672&quot;&gt;{&lt;/span&gt;
    &lt;span style=&quot;color:#75715e&quot;&gt;// Initialize the path.
</code></pre><p>FileUtils.forceMkdir(new File(dataPath));
// Initialize the global timer. TimerManager.init(50);</p><pre><code>    &lt;span style=&quot;color:#75715e&quot;&gt;// Here Raft RPC and business RPC share the same RPC server. They can use different RPC servers, too.
</code></pre><p>RpcServer rpcServer = new RpcServer(serverId.getPort());
RaftRpcServerFactory.addRaftRequestProcessors(rpcServer);
// Register the business processor. rpcServer.registerUserProcessor(new GetValueRequestProcessor(this));
rpcServer.registerUserProcessor(new IncrementAndGetRequestProcessor(this));
// Initialize the state machine. this.fsm = new CounterStateMachine();
// Set the state machine to the startup parameters. nodeOptions.setFsm(this.fsm);
// Set the storage path. // Required. Specify the log. nodeOptions.setLogUri(dataPath + File.separator + "log");
// Required. Specify the metadata. nodeOptions.setRaftMetaUri(dataPath + File.separator + "raft_meta");
// Recommended. Specify the snapshot. nodeOptions.setSnapshotUri(dataPath + File.separator + "snapshot");
// Initialize the Raft group service framework. this.raftGroupService = new RaftGroupService(groupId, serverId, nodeOptions, rpcServer);
// Startup this.node = this.raftGroupService.start();
}</p><pre><code>&lt;span style=&quot;color:#66d9ef&quot;&gt;public&lt;/span&gt; CounterStateMachine &lt;span style=&quot;color:#a6e22e&quot;&gt;getFsm&lt;/span&gt;&lt;span style=&quot;color:#f92672&quot;&gt;()&lt;/span&gt; &lt;span style=&quot;color:#f92672&quot;&gt;{&lt;/span&gt;
    &lt;span style=&quot;color:#66d9ef&quot;&gt;return&lt;/span&gt; &lt;span style=&quot;color:#66d9ef&quot;&gt;this&lt;/span&gt;&lt;span style=&quot;color:#f92672&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color:#a6e22e&quot;&gt;fsm&lt;/span&gt;&lt;span style=&quot;color:#f92672&quot;&gt;;&lt;/span&gt;
&lt;span style=&quot;color:#f92672&quot;&gt;}&lt;/span&gt;

&lt;span style=&quot;color:#66d9ef&quot;&gt;public&lt;/span&gt; Node &lt;span style=&quot;color:#a6e22e&quot;&gt;getNode&lt;/span&gt;&lt;span style=&quot;color:#f92672&quot;&gt;()&lt;/span&gt; &lt;span style=&quot;color:#f92672&quot;&gt;{&lt;/span&gt;
    &lt;span style=&quot;color:#66d9ef&quot;&gt;return&lt;/span&gt; &lt;span style=&quot;color:#66d9ef&quot;&gt;this&lt;/span&gt;&lt;span style=&quot;color:#f92672&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color:#a6e22e&quot;&gt;node&lt;/span&gt;&lt;span style=&quot;color:#f92672&quot;&gt;;&lt;/span&gt;
&lt;span style=&quot;color:#f92672&quot;&gt;}&lt;/span&gt;

&lt;span style=&quot;color:#66d9ef&quot;&gt;public&lt;/span&gt; RaftGroupService &lt;span style=&quot;color:#a6e22e&quot;&gt;RaftGroupService&lt;/span&gt;&lt;span style=&quot;color:#f92672&quot;&gt;()&lt;/span&gt; &lt;span style=&quot;color:#f92672&quot;&gt;{&lt;/span&gt;
    &lt;span style=&quot;color:#66d9ef&quot;&gt;return&lt;/span&gt; &lt;span style=&quot;color:#66d9ef&quot;&gt;this&lt;/span&gt;&lt;span style=&quot;color:#f92672&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color:#a6e22e&quot;&gt;raftGroupService&lt;/span&gt;&lt;span style=&quot;color:#f92672&quot;&gt;;&lt;/span&gt;
&lt;span style=&quot;color:#f92672&quot;&gt;}&lt;/span&gt;

&lt;span style=&quot;color:#75715e&quot;&gt;/**
</code></pre><p>* Generate the redirect request. */
public ValueResponse redirect() {
ValueResponse response = new ValueResponse();
response.setSuccess(false);
if (node != null) {
PeerId leader = node.getLeaderId();
if (leader != null) {
response.setRedirect(leader.toString());
}
}</p><pre><code>    &lt;span style=&quot;color:#66d9ef&quot;&gt;return&lt;/span&gt; response&lt;span style=&quot;color:#f92672&quot;&gt;;&lt;/span&gt;
&lt;span style=&quot;color:#f92672&quot;&gt;}&lt;/span&gt;

&lt;span style=&quot;color:#66d9ef&quot;&gt;public&lt;/span&gt; &lt;span style=&quot;color:#66d9ef&quot;&gt;static&lt;/span&gt; &lt;span style=&quot;color:#66d9ef&quot;&gt;void&lt;/span&gt; &lt;span style=&quot;color:#a6e22e&quot;&gt;main&lt;/span&gt;&lt;span style=&quot;color:#f92672&quot;&gt;(&lt;/span&gt;String&lt;span style=&quot;color:#f92672&quot;&gt;[]&lt;/span&gt; args&lt;span style=&quot;color:#f92672&quot;&gt;)&lt;/span&gt; &lt;span style=&quot;color:#66d9ef&quot;&gt;throws&lt;/span&gt; IOException &lt;span style=&quot;color:#f92672&quot;&gt;{&lt;/span&gt;
    &lt;span style=&quot;color:#66d9ef&quot;&gt;if&lt;/span&gt; &lt;span style=&quot;color:#f92672&quot;&gt;(&lt;/span&gt;args&lt;span style=&quot;color:#f92672&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color:#a6e22e&quot;&gt;length&lt;/span&gt; &lt;span style=&quot;color:#f92672&quot;&gt;!=&lt;/span&gt; 4&lt;span style=&quot;color:#f92672&quot;&gt;)&lt;/span&gt; &lt;span style=&quot;color:#f92672&quot;&gt;{&lt;/span&gt;
        System&lt;span style=&quot;color:#f92672&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color:#a6e22e&quot;&gt;out&lt;/span&gt;
            &lt;span style=&quot;color:#f92672&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color:#a6e22e&quot;&gt;println&lt;/span&gt;&lt;span style=&quot;color:#f92672&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color:#e6db74&quot;&gt;&amp;#34;Useage : java com.alipay.jraft.example.counter.CounterServer {dataPath} {groupId} {serverId} {initConf}&amp;#34;&lt;/span&gt;&lt;span style=&quot;color:#f92672&quot;&gt;);&lt;/span&gt;
        System&lt;span style=&quot;color:#f92672&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color:#a6e22e&quot;&gt;out&lt;/span&gt;
            &lt;span style=&quot;color:#f92672&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color:#a6e22e&quot;&gt;println&lt;/span&gt;&lt;span style=&quot;color:#f92672&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color:#e6db74&quot;&gt;&amp;#34;Example: java com.alipay.jraft.example.counter.CounterServer /tmp/server1 counter 127.0.0.1:8081 127.0.0.1:8081,127.0.0.1:8082,127.0.0.1:8083&amp;#34;&lt;/span&gt;&lt;span style=&quot;color:#f92672&quot;&gt;);&lt;/span&gt;
        System&lt;span style=&quot;color:#f92672&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color:#a6e22e&quot;&gt;exit&lt;/span&gt;&lt;span style=&quot;color:#f92672&quot;&gt;(&lt;/span&gt;1&lt;span style=&quot;color:#f92672&quot;&gt;);&lt;/span&gt;
    &lt;span style=&quot;color:#f92672&quot;&gt;}&lt;/span&gt;
    String dataPath &lt;span style=&quot;color:#f92672&quot;&gt;=&lt;/span&gt; args&lt;span style=&quot;color:#f92672&quot;&gt;[&lt;/span&gt;0&lt;span style=&quot;color:#f92672&quot;&gt;];&lt;/span&gt;
    String groupId &lt;span style=&quot;color:#f92672&quot;&gt;=&lt;/span&gt; args&lt;span style=&quot;color:#f92672&quot;&gt;[&lt;/span&gt;1&lt;span style=&quot;color:#f92672&quot;&gt;];&lt;/span&gt;
    String serverIdStr &lt;span style=&quot;color:#f92672&quot;&gt;=&lt;/span&gt; args&lt;span style=&quot;color:#f92672&quot;&gt;[&lt;/span&gt;2&lt;span style=&quot;color:#f92672&quot;&gt;];&lt;/span&gt;
    String initConfStr &lt;span style=&quot;color:#f92672&quot;&gt;=&lt;/span&gt; args&lt;span style=&quot;color:#f92672&quot;&gt;[&lt;/span&gt;3&lt;span style=&quot;color:#f92672&quot;&gt;];&lt;/span&gt;

    NodeOptions nodeOptions &lt;span style=&quot;color:#f92672&quot;&gt;=&lt;/span&gt; &lt;span style=&quot;color:#66d9ef&quot;&gt;new&lt;/span&gt; NodeOptions&lt;span style=&quot;color:#f92672&quot;&gt;();&lt;/span&gt;
    &lt;span style=&quot;color:#75715e&quot;&gt;// Adjust arguments such as the snapshot interval for testing.
</code></pre><p>nodeOptions.setElectionTimeoutMs(5000);
nodeOptions.setDisableCli(false);
nodeOptions.setSnapshotIntervalSecs(30);
// Parse the parameter. PeerId serverId = new PeerId();
if (!serverId.parse(serverIdStr)) {
throw new IllegalArgumentException("Fail to parse serverId:" + serverIdStr);
}
Configuration initConf = new Configuration();
if (!initConf.parse(initConfStr)) {
throw new IllegalArgumentException("Fail to parse initConf:" + initConfStr);
}
// Set the initial cluster configuration. nodeOptions.setInitialConf(initConf);</p><pre><code>    &lt;span style=&quot;color:#75715e&quot;&gt;// Startup
</code></pre><p>CounterServer counterServer = new CounterServer(dataPath, groupId, serverId, nodeOptions);
System.out.println("Started counter server at port:"
+ counterServer.getNode().getNodeId().getPeerId().getPort());
}
}
Parameters for starting three nodes are similar:</p><pre><code>&lt;span style=&quot;color:#66d9ef&quot;&gt;private&lt;/span&gt; CounterServer       counterServer&lt;span style=&quot;color:#f92672&quot;&gt;;&lt;/span&gt;

&lt;span style=&quot;color:#66d9ef&quot;&gt;public&lt;/span&gt; &lt;span style=&quot;color:#a6e22e&quot;&gt;IncrementAndGetRequestProcessor&lt;/span&gt;&lt;span style=&quot;color:#f92672&quot;&gt;(&lt;/span&gt;CounterServer counterServer&lt;span style=&quot;color:#f92672&quot;&gt;)&lt;/span&gt; &lt;span style=&quot;color:#f92672&quot;&gt;{&lt;/span&gt;
    &lt;span style=&quot;color:#66d9ef&quot;&gt;super&lt;/span&gt;&lt;span style=&quot;color:#f92672&quot;&gt;();&lt;/span&gt;
    &lt;span style=&quot;color:#66d9ef&quot;&gt;this&lt;/span&gt;&lt;span style=&quot;color:#f92672&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color:#a6e22e&quot;&gt;counterServer&lt;/span&gt; &lt;span style=&quot;color:#f92672&quot;&gt;=&lt;/span&gt; counterServer&lt;span style=&quot;color:#f92672&quot;&gt;;&lt;/span&gt;
&lt;span style=&quot;color:#f92672&quot;&gt;}&lt;/span&gt;

&lt;span style=&quot;color:#a6e22e&quot;&gt;@Override&lt;/span&gt;
&lt;span style=&quot;color:#66d9ef&quot;&gt;public&lt;/span&gt; &lt;span style=&quot;color:#66d9ef&quot;&gt;void&lt;/span&gt; &lt;span style=&quot;color:#a6e22e&quot;&gt;handleRequest&lt;/span&gt;&lt;span style=&quot;color:#f92672&quot;&gt;(&lt;/span&gt;BizContext bizCtx&lt;span style=&quot;color:#f92672&quot;&gt;,&lt;/span&gt; AsyncContext asyncCtx&lt;span style=&quot;color:#f92672&quot;&gt;,&lt;/span&gt; IncrementAndGetRequest request&lt;span style=&quot;color:#f92672&quot;&gt;)&lt;/span&gt; &lt;span style=&quot;color:#f92672&quot;&gt;{&lt;/span&gt;
</code></pre><p>　　　　　// Generate a redirect request if the node is not the leader. if (!counterServer.getFsm().isLeader()) {
asyncCtx.sendResponse(counterServer.redirect());
return;
}</p><pre><code>    &lt;span style=&quot;color:#75715e&quot;&gt;// Create a response callback.
</code></pre><p>ValueResponse response = new ValueResponse();
IncrementAndAddClosure closure = new IncrementAndAddClosure(counterServer, request, response, new Closure() {</p><pre><code>        &lt;span style=&quot;color:#a6e22e&quot;&gt;@Override&lt;/span&gt;
        &lt;span style=&quot;color:#66d9ef&quot;&gt;public&lt;/span&gt; &lt;span style=&quot;color:#66d9ef&quot;&gt;void&lt;/span&gt; &lt;span style=&quot;color:#a6e22e&quot;&gt;run&lt;/span&gt;&lt;span style=&quot;color:#f92672&quot;&gt;(&lt;/span&gt;Status status&lt;span style=&quot;color:#f92672&quot;&gt;)&lt;/span&gt; &lt;span style=&quot;color:#f92672&quot;&gt;{&lt;/span&gt;
            &lt;span style=&quot;color:#75715e&quot;&gt;// Responses
</code></pre><p>if (!status.isOk()) {
// Return the error message if the request fails. response.setErrorMsg(status.getErrorMsg());
response.setSuccess(false);
}
// Return the ValueResponse if the request is successful. asyncCtx.sendResponse(response);</p><pre><code>        &lt;span style=&quot;color:#f92672&quot;&gt;}&lt;/span&gt;
    &lt;span style=&quot;color:#f92672&quot;&gt;});&lt;/span&gt;

    &lt;span style=&quot;color:#66d9ef&quot;&gt;try&lt;/span&gt; &lt;span style=&quot;color:#f92672&quot;&gt;{&lt;/span&gt;
        &lt;span style=&quot;color:#75715e&quot;&gt;// Create a task.
</code></pre><p>Task task = new Task();
task.setDone(closure); // Set the callback // Serialize the request by using Codecs.Hessian2, and fill in the serialized data in the data field. task.setData(ByteBuffer.wrap(Codecs.getSerializer(Codecs.Hessian2).encode(request)));</p><pre><code>        &lt;span style=&quot;color:#75715e&quot;&gt;// Submit the task to the Raft group.
</code></pre><p>counterServer.getNode().apply(task);
} catch (CodecException e) {
// Serialization exception LOG.error("Fail to encode IncrementAndGetRequest", e);
ValueResponse responseObject = response;
responseObject.setSuccess(false);
responseObject.setErrorMsg(e.getMessage());
asyncCtx.sendResponse(responseObject);
}
}</p><pre><code>&lt;span style=&quot;color:#a6e22e&quot;&gt;@Override&lt;/span&gt;
&lt;span style=&quot;color:#66d9ef&quot;&gt;public&lt;/span&gt; String &lt;span style=&quot;color:#a6e22e&quot;&gt;interest&lt;/span&gt;&lt;span style=&quot;color:#f92672&quot;&gt;()&lt;/span&gt; &lt;span style=&quot;color:#f92672&quot;&gt;{&lt;/span&gt;
    &lt;span style=&quot;color:#66d9ef&quot;&gt;return&lt;/span&gt; IncrementAndGetRequest&lt;span style=&quot;color:#f92672&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color:#a6e22e&quot;&gt;class&lt;/span&gt;&lt;span style=&quot;color:#f92672&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color:#a6e22e&quot;&gt;getName&lt;/span&gt;&lt;span style=&quot;color:#f92672&quot;&gt;();&lt;/span&gt;
&lt;span style=&quot;color:#f92672&quot;&gt;}&lt;/span&gt;
</code></pre><p>}
Client</p><pre><code>    Configuration conf &lt;span style=&quot;color:#f92672&quot;&gt;=&lt;/span&gt; &lt;span style=&quot;color:#66d9ef&quot;&gt;new&lt;/span&gt; Configuration&lt;span style=&quot;color:#f92672&quot;&gt;();&lt;/span&gt;
    &lt;span style=&quot;color:#66d9ef&quot;&gt;if&lt;/span&gt; &lt;span style=&quot;color:#f92672&quot;&gt;(!&lt;/span&gt;conf&lt;span style=&quot;color:#f92672&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color:#a6e22e&quot;&gt;parse&lt;/span&gt;&lt;span style=&quot;color:#f92672&quot;&gt;(&lt;/span&gt;confStr&lt;span style=&quot;color:#f92672&quot;&gt;))&lt;/span&gt; &lt;span style=&quot;color:#f92672&quot;&gt;{&lt;/span&gt;
        &lt;span style=&quot;color:#66d9ef&quot;&gt;throw&lt;/span&gt; &lt;span style=&quot;color:#66d9ef&quot;&gt;new&lt;/span&gt; IllegalArgumentException&lt;span style=&quot;color:#f92672&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color:#e6db74&quot;&gt;&amp;#34;Fail to parse conf:&amp;#34;&lt;/span&gt; &lt;span style=&quot;color:#f92672&quot;&gt;+&lt;/span&gt; confStr&lt;span style=&quot;color:#f92672&quot;&gt;);&lt;/span&gt;
    &lt;span style=&quot;color:#f92672&quot;&gt;}&lt;/span&gt;
    &lt;span style=&quot;color:#75715e&quot;&gt;// Update the Raft group configuration.
</code></pre><p>RouteTable.getInstance().updateConfiguration(groupId, conf);
Next, initialize the RPC client and update the route table:</p><p>if (!RouteTable.getInstance().refreshLeader(cliClientService, groupId, 1000).isOk()) {
throw new IllegalStateException("Refresh leader failed");
}
Obtain the latest leader and send the request:</p><pre><code>        &lt;span style=&quot;color:#a6e22e&quot;&gt;@Override&lt;/span&gt;
        &lt;span style=&quot;color:#66d9ef&quot;&gt;public&lt;/span&gt; &lt;span style=&quot;color:#66d9ef&quot;&gt;void&lt;/span&gt; &lt;span style=&quot;color:#a6e22e&quot;&gt;onResponse&lt;/span&gt;&lt;span style=&quot;color:#f92672&quot;&gt;(&lt;/span&gt;Object result&lt;span style=&quot;color:#f92672&quot;&gt;)&lt;/span&gt; &lt;span style=&quot;color:#f92672&quot;&gt;{&lt;/span&gt;
            latch&lt;span style=&quot;color:#f92672&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color:#a6e22e&quot;&gt;countDown&lt;/span&gt;&lt;span style=&quot;color:#f92672&quot;&gt;();&lt;/span&gt;
            System&lt;span style=&quot;color:#f92672&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color:#a6e22e&quot;&gt;out&lt;/span&gt;&lt;span style=&quot;color:#f92672&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color:#a6e22e&quot;&gt;println&lt;/span&gt;&lt;span style=&quot;color:#f92672&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color:#e6db74&quot;&gt;&amp;#34;incrementAndGet result:&amp;#34;&lt;/span&gt; &lt;span style=&quot;color:#f92672&quot;&gt;+&lt;/span&gt; result&lt;span style=&quot;color:#f92672&quot;&gt;);&lt;/span&gt;
        &lt;span style=&quot;color:#f92672&quot;&gt;}&lt;/span&gt;

        &lt;span style=&quot;color:#a6e22e&quot;&gt;@Override&lt;/span&gt;
        &lt;span style=&quot;color:#66d9ef&quot;&gt;public&lt;/span&gt; &lt;span style=&quot;color:#66d9ef&quot;&gt;void&lt;/span&gt; &lt;span style=&quot;color:#a6e22e&quot;&gt;onException&lt;/span&gt;&lt;span style=&quot;color:#f92672&quot;&gt;(&lt;/span&gt;Throwable e&lt;span style=&quot;color:#f92672&quot;&gt;)&lt;/span&gt; &lt;span style=&quot;color:#f92672&quot;&gt;{&lt;/span&gt;
            e&lt;span style=&quot;color:#f92672&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color:#a6e22e&quot;&gt;printStackTrace&lt;/span&gt;&lt;span style=&quot;color:#f92672&quot;&gt;();&lt;/span&gt;
            latch&lt;span style=&quot;color:#f92672&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color:#a6e22e&quot;&gt;countDown&lt;/span&gt;&lt;span style=&quot;color:#f92672&quot;&gt;();&lt;/span&gt;

        &lt;span style=&quot;color:#f92672&quot;&gt;}&lt;/span&gt;

        &lt;span style=&quot;color:#a6e22e&quot;&gt;@Override&lt;/span&gt;
        &lt;span style=&quot;color:#66d9ef&quot;&gt;public&lt;/span&gt; Executor &lt;span style=&quot;color:#a6e22e&quot;&gt;getExecutor&lt;/span&gt;&lt;span style=&quot;color:#f92672&quot;&gt;()&lt;/span&gt; &lt;span style=&quot;color:#f92672&quot;&gt;{&lt;/span&gt;
            &lt;span style=&quot;color:#66d9ef&quot;&gt;return&lt;/span&gt; &lt;span style=&quot;color:#66d9ef&quot;&gt;null&lt;/span&gt;&lt;span style=&quot;color:#f92672&quot;&gt;;&lt;/span&gt;
        &lt;span style=&quot;color:#f92672&quot;&gt;}&lt;/span&gt;
    &lt;span style=&quot;color:#f92672&quot;&gt;},&lt;/span&gt; 5000&lt;span style=&quot;color:#f92672&quot;&gt;);&lt;/span&gt;
</code></pre><p>}
Snapshot implementation</p><pre><code>&lt;span style=&quot;color:#66d9ef&quot;&gt;public&lt;/span&gt; &lt;span style=&quot;color:#a6e22e&quot;&gt;CounterSnapshotFile&lt;/span&gt;&lt;span style=&quot;color:#f92672&quot;&gt;(&lt;/span&gt;String path&lt;span style=&quot;color:#f92672&quot;&gt;)&lt;/span&gt; &lt;span style=&quot;color:#f92672&quot;&gt;{&lt;/span&gt;
    &lt;span style=&quot;color:#66d9ef&quot;&gt;super&lt;/span&gt;&lt;span style=&quot;color:#f92672&quot;&gt;();&lt;/span&gt;
    &lt;span style=&quot;color:#66d9ef&quot;&gt;this&lt;/span&gt;&lt;span style=&quot;color:#f92672&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color:#a6e22e&quot;&gt;path&lt;/span&gt; &lt;span style=&quot;color:#f92672&quot;&gt;=&lt;/span&gt; path&lt;span style=&quot;color:#f92672&quot;&gt;;&lt;/span&gt;
&lt;span style=&quot;color:#f92672&quot;&gt;}&lt;/span&gt;

&lt;span style=&quot;color:#66d9ef&quot;&gt;public&lt;/span&gt; String &lt;span style=&quot;color:#a6e22e&quot;&gt;getPath&lt;/span&gt;&lt;span style=&quot;color:#f92672&quot;&gt;()&lt;/span&gt; &lt;span style=&quot;color:#f92672&quot;&gt;{&lt;/span&gt;
    &lt;span style=&quot;color:#66d9ef&quot;&gt;return&lt;/span&gt; &lt;span style=&quot;color:#66d9ef&quot;&gt;this&lt;/span&gt;&lt;span style=&quot;color:#f92672&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color:#a6e22e&quot;&gt;path&lt;/span&gt;&lt;span style=&quot;color:#f92672&quot;&gt;;&lt;/span&gt;
&lt;span style=&quot;color:#f92672&quot;&gt;}&lt;/span&gt;

&lt;span style=&quot;color:#75715e&quot;&gt;/**
</code></pre><p>* Save value to snapshot file. * @param value * @return */
public boolean save(long value) {
try {
FileUtils.writeStringToFile(new File(path), String.valueOf(value));
return true;
} catch (IOException e) {
LOG.error("Fail to save snapshot", e);
return false;
}
}</p><pre><code>&lt;span style=&quot;color:#66d9ef&quot;&gt;public&lt;/span&gt; &lt;span style=&quot;color:#66d9ef&quot;&gt;long&lt;/span&gt; &lt;span style=&quot;color:#a6e22e&quot;&gt;load&lt;/span&gt;&lt;span style=&quot;color:#f92672&quot;&gt;()&lt;/span&gt; &lt;span style=&quot;color:#66d9ef&quot;&gt;throws&lt;/span&gt; IOException &lt;span style=&quot;color:#f92672&quot;&gt;{&lt;/span&gt;
    String s &lt;span style=&quot;color:#f92672&quot;&gt;=&lt;/span&gt; FileUtils&lt;span style=&quot;color:#f92672&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color:#a6e22e&quot;&gt;readFileToString&lt;/span&gt;&lt;span style=&quot;color:#f92672&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color:#66d9ef&quot;&gt;new&lt;/span&gt; File&lt;span style=&quot;color:#f92672&quot;&gt;(&lt;/span&gt;path&lt;span style=&quot;color:#f92672&quot;&gt;));&lt;/span&gt;
    &lt;span style=&quot;color:#66d9ef&quot;&gt;if&lt;/span&gt; &lt;span style=&quot;color:#f92672&quot;&gt;(!&lt;/span&gt;StringUtils&lt;span style=&quot;color:#f92672&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color:#a6e22e&quot;&gt;isBlank&lt;/span&gt;&lt;span style=&quot;color:#f92672&quot;&gt;(&lt;/span&gt;s&lt;span style=&quot;color:#f92672&quot;&gt;))&lt;/span&gt; &lt;span style=&quot;color:#f92672&quot;&gt;{&lt;/span&gt;
        &lt;span style=&quot;color:#66d9ef&quot;&gt;return&lt;/span&gt; Long&lt;span style=&quot;color:#f92672&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color:#a6e22e&quot;&gt;parseLong&lt;/span&gt;&lt;span style=&quot;color:#f92672&quot;&gt;(&lt;/span&gt;s&lt;span style=&quot;color:#f92672&quot;&gt;);&lt;/span&gt;
    &lt;span style=&quot;color:#f92672&quot;&gt;}&lt;/span&gt;
    &lt;span style=&quot;color:#66d9ef&quot;&gt;throw&lt;/span&gt; &lt;span style=&quot;color:#66d9ef&quot;&gt;new&lt;/span&gt; IOException&lt;span style=&quot;color:#f92672&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color:#e6db74&quot;&gt;&amp;#34;Fail to load snapshot from &amp;#34;&lt;/span&gt; &lt;span style=&quot;color:#f92672&quot;&gt;+&lt;/span&gt; path &lt;span style=&quot;color:#f92672&quot;&gt;+&lt;/span&gt; &lt;span style=&quot;color:#e6db74&quot;&gt;&amp;#34;,content: &amp;#34;&lt;/span&gt; &lt;span style=&quot;color:#f92672&quot;&gt;+&lt;/span&gt; s&lt;span style=&quot;color:#f92672&quot;&gt;);&lt;/span&gt;
&lt;span style=&quot;color:#f92672&quot;&gt;}&lt;/span&gt;
</code></pre><p>}
Save the file to the specified path.</p><pre><code>&lt;span style=&quot;color:#f92672&quot;&gt;}&lt;/span&gt;

  &lt;span style=&quot;color:#66d9ef&quot;&gt;public&lt;/span&gt; &lt;span style=&quot;color:#66d9ef&quot;&gt;void&lt;/span&gt; &lt;span style=&quot;color:#a6e22e&quot;&gt;onSnapshotSave&lt;/span&gt;&lt;span style=&quot;color:#f92672&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color:#66d9ef&quot;&gt;final&lt;/span&gt; SnapshotWriter writer&lt;span style=&quot;color:#f92672&quot;&gt;,&lt;/span&gt; &lt;span style=&quot;color:#66d9ef&quot;&gt;final&lt;/span&gt; Closure done&lt;span style=&quot;color:#f92672&quot;&gt;)&lt;/span&gt; &lt;span style=&quot;color:#f92672&quot;&gt;{&lt;/span&gt;
    &lt;span style=&quot;color:#75715e&quot;&gt;// Obtain the current state of the state machine.
</code></pre><p>       final long currVal = this.value.get();
// Asynchronously save the snapshot to avoid blocking the state machine. Utils.runInThread(new Runnable() {</p><pre><code>        &lt;span style=&quot;color:#a6e22e&quot;&gt;@Override&lt;/span&gt;
        &lt;span style=&quot;color:#66d9ef&quot;&gt;public&lt;/span&gt; &lt;span style=&quot;color:#66d9ef&quot;&gt;void&lt;/span&gt; &lt;span style=&quot;color:#a6e22e&quot;&gt;run&lt;/span&gt;&lt;span style=&quot;color:#f92672&quot;&gt;()&lt;/span&gt; &lt;span style=&quot;color:#f92672&quot;&gt;{&lt;/span&gt;
            CounterSnapshotFile snapshot &lt;span style=&quot;color:#f92672&quot;&gt;=&lt;/span&gt; &lt;span style=&quot;color:#66d9ef&quot;&gt;new&lt;/span&gt; CounterSnapshotFile&lt;span style=&quot;color:#f92672&quot;&gt;(&lt;/span&gt;writer&lt;span style=&quot;color:#f92672&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color:#a6e22e&quot;&gt;getPath&lt;/span&gt;&lt;span style=&quot;color:#f92672&quot;&gt;()&lt;/span&gt; &lt;span style=&quot;color:#f92672&quot;&gt;+&lt;/span&gt; File&lt;span style=&quot;color:#f92672&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color:#a6e22e&quot;&gt;separator&lt;/span&gt; &lt;span style=&quot;color:#f92672&quot;&gt;+&lt;/span&gt; &lt;span style=&quot;color:#e6db74&quot;&gt;&amp;#34;data&amp;#34;&lt;/span&gt;&lt;span style=&quot;color:#f92672&quot;&gt;);&lt;/span&gt;
            &lt;span style=&quot;color:#66d9ef&quot;&gt;if&lt;/span&gt; &lt;span style=&quot;color:#f92672&quot;&gt;(&lt;/span&gt;snapshot&lt;span style=&quot;color:#f92672&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color:#a6e22e&quot;&gt;save&lt;/span&gt;&lt;span style=&quot;color:#f92672&quot;&gt;(&lt;/span&gt;currVal&lt;span style=&quot;color:#f92672&quot;&gt;))&lt;/span&gt; &lt;span style=&quot;color:#f92672&quot;&gt;{&lt;/span&gt;
                &lt;span style=&quot;color:#66d9ef&quot;&gt;if&lt;/span&gt; &lt;span style=&quot;color:#f92672&quot;&gt;(&lt;/span&gt;writer&lt;span style=&quot;color:#f92672&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color:#a6e22e&quot;&gt;addFile&lt;/span&gt;&lt;span style=&quot;color:#f92672&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color:#e6db74&quot;&gt;&amp;#34;data&amp;#34;&lt;/span&gt;&lt;span style=&quot;color:#f92672&quot;&gt;))&lt;/span&gt; &lt;span style=&quot;color:#f92672&quot;&gt;{&lt;/span&gt;
                    done&lt;span style=&quot;color:#f92672&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color:#a6e22e&quot;&gt;run&lt;/span&gt;&lt;span style=&quot;color:#f92672&quot;&gt;(&lt;/span&gt;Status&lt;span style=&quot;color:#f92672&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color:#a6e22e&quot;&gt;OK&lt;/span&gt;&lt;span style=&quot;color:#f92672&quot;&gt;());&lt;/span&gt;
                &lt;span style=&quot;color:#f92672&quot;&gt;}&lt;/span&gt; &lt;span style=&quot;color:#66d9ef&quot;&gt;else&lt;/span&gt; &lt;span style=&quot;color:#f92672&quot;&gt;{&lt;/span&gt;
                    done&lt;span style=&quot;color:#f92672&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color:#a6e22e&quot;&gt;run&lt;/span&gt;&lt;span style=&quot;color:#f92672&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color:#66d9ef&quot;&gt;new&lt;/span&gt; Status&lt;span style=&quot;color:#f92672&quot;&gt;(&lt;/span&gt;RaftError&lt;span style=&quot;color:#f92672&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color:#a6e22e&quot;&gt;EIO&lt;/span&gt;&lt;span style=&quot;color:#f92672&quot;&gt;,&lt;/span&gt; &lt;span style=&quot;color:#e6db74&quot;&gt;&amp;#34;Fail to add file to writer&amp;#34;&lt;/span&gt;&lt;span style=&quot;color:#f92672&quot;&gt;));&lt;/span&gt;
                &lt;span style=&quot;color:#f92672&quot;&gt;}&lt;/span&gt;
            &lt;span style=&quot;color:#f92672&quot;&gt;}&lt;/span&gt; &lt;span style=&quot;color:#66d9ef&quot;&gt;else&lt;/span&gt; &lt;span style=&quot;color:#f92672&quot;&gt;{&lt;/span&gt;
                done&lt;span style=&quot;color:#f92672&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color:#a6e22e&quot;&gt;run&lt;/span&gt;&lt;span style=&quot;color:#f92672&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color:#66d9ef&quot;&gt;new&lt;/span&gt; Status&lt;span style=&quot;color:#f92672&quot;&gt;(&lt;/span&gt;RaftError&lt;span style=&quot;color:#f92672&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color:#a6e22e&quot;&gt;EIO&lt;/span&gt;&lt;span style=&quot;color:#f92672&quot;&gt;,&lt;/span&gt; &lt;span style=&quot;color:#e6db74&quot;&gt;&amp;#34;Fail to save counter snapshot %s&amp;#34;&lt;/span&gt;&lt;span style=&quot;color:#f92672&quot;&gt;,&lt;/span&gt; snapshot&lt;span style=&quot;color:#f92672&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color:#a6e22e&quot;&gt;getPath&lt;/span&gt;&lt;span style=&quot;color:#f92672&quot;&gt;()));&lt;/span&gt;
            &lt;span style=&quot;color:#f92672&quot;&gt;}&lt;/span&gt;
        &lt;span style=&quot;color:#f92672&quot;&gt;}&lt;/span&gt;
    &lt;span style=&quot;color:#f92672&quot;&gt;});&lt;/span&gt;
&lt;span style=&quot;color:#f92672&quot;&gt;}&lt;/span&gt;
</code></pre><p>You can set the snapshot interval by using the snapshotIntervalSecs method of NodeOptions. The default interval is one hour.</p></article></main></div><footer class=ss-footer><div class=container><div class=links><div class=cate><h2 class=cate-title>Resources</h2><a class=link href=https://github.com/sofastack>Github</a>
<a class=link href=https://gitee.com/sofastack/>Gitee</a>
<a class=link href=https://github.com/sofastack-guides>Samples</a></div><div class=cate><h2 class=cate-title>Social Media</h2><a class=link href=https://zhuanlan.zhihu.com/sofastack>Zhihu</a>
<a class=link href=https://weibo.com/sofastack>Weibo</a>
<a class=link href=https://twitter.com/sofastack_io>Twitter</a></div><div class=cate><h2 class=cate-title>Get Involved</h2><a class=link href=https://github.com/sofastack/sofastack.tech/issues>Feedback</a>
<a class=link href=https://github.com/sofastack/community>Community</a>
<a class=link href=https://github.com/sofastack/sofastack.tech/wiki>Wiki</a>
<a class=link href=mailto:sofa@alipay.cloud.com>Email</a></div><div class=cate><h2 class=cate-title>Ant Financial Open Source</h2><a class=link href=https://ant.design/>Ant Design</a>
<a class=link href=https://eggjs.org/>Egg</a>
<a class=link href=https://sqlflow.org>SQLFlow</a>
<a class=link href=https://tech.antfin.com/open-source>More</a></div></div><div class=qrcode><div><img class=qrcode-img src=/img/qrcode/qrcode_1.png><p class=qrcode-desc>Wechat Official Account</p></div><div><img class=qrcode-img src=/img/qrcode/qrcode_2.png><p class=qrcode-desc>DingTalk Group</p></div></div></div><div class=copyright><p>© 2019 - 2020 The SOFAStack Authors
<a href=http://beian.miit.gov.cn/>浙 ICP 备 16045294 号-3</a></p></div></footer></body></html>